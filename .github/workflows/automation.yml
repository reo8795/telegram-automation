# .github/workflows/automation.yml
name: í…”ë ˆê·¸ë¨ ìë™ ì•Œë¦¼

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 7ì‹œ (í•œêµ­ì‹œê°„) - UTCë¡œëŠ” ì˜¤í›„ 10ì‹œ
    - cron: '0 22 * * *'
    # 4ì‹œê°„ë§ˆë‹¤ ì¢…ëª© ì²´í¬
    - cron: '0 */4 * * *'
  
  # ìˆ˜ë™ìœ¼ë¡œë„ ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:

env:
  TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
  CHAT_ID: ${{ secrets.CHAT_ID }}

jobs:
  # ì‘ì—… 1: ê³µí¬íƒìš•ì§€ìˆ˜ ì „ì†¡ (ë§¤ì¼ 7ì‹œ)
  send-fear-greed:
    runs-on: ubuntu-latest
    
    steps:
    - name: ê³µí¬íƒìš•ì§€ìˆ˜ ê°€ì ¸ì˜¤ê¸° ë° ì „ì†¡
      run: |
        echo "ğŸš€ ê³µí¬íƒìš•ì§€ìˆ˜ ì‘ì—… ì‹œì‘"
        
        # APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        response=$(curl -s "https://api.alternative.me/fng/")
        echo "API ì‘ë‹µ í™•ì¸ë¨"
        
        # í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ (ê°„ë‹¨í•œ ë°©ë²• ì‚¬ìš©)
        value=$(echo "$response" | grep -o '"value":"[^"]*' | head -1 | cut -d'"' -f4)
        classification=$(echo "$response" | grep -o '"value_classification":"[^"]*' | head -1 | cut -d'"' -f4)
        
        echo "ì§€ìˆ˜: $value"
        echo "ë¶„ë¥˜: $classification"
        
        # ê¸°ë³¸ê°’ ì„¤ì • (ë°ì´í„° ì—†ì„ ê²½ìš°)
        if [ -z "$value" ]; then
          value="50"
          classification="Neutral"
        fi
        
        # ì´ëª¨ì§€ ì„ íƒ
        if [ "$value" -le 24 ]; then
          emoji="ğŸ˜±"
        elif [ "$value" -le 49 ]; then
          emoji="ğŸ˜°"
        elif [ "$value" -le 74 ]; then
          emoji="ğŸ¤‘"
        else
          emoji="ğŸ¤¯"
        fi
        
        # í˜„ì¬ ì‹œê°„ (í•œêµ­ ì‹œê°„)
        current_time=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
        
        # ë©”ì‹œì§€ êµ¬ì„±
        message="${emoji} ì˜¤ëŠ˜ì˜ ê³µí¬íƒìš•ì§€ìˆ˜

í˜„ì¬ ì§€ìˆ˜: ${value}/100
ìƒíƒœ: ${classification}

ğŸ’¡ ì§€ìˆ˜ í•´ì„:
0-24: ê·¹ë„ì˜ ê³µí¬ ğŸ˜± (ë§¤ìˆ˜ ê¸°íšŒ)
25-49: ê³µí¬ ğŸ˜° (ì‹ ì¤‘í•œ ë§¤ìˆ˜)
50-74: íƒìš• ğŸ¤‘ (ì‹ ì¤‘í•œ ë§¤ë„)
75-100: ê·¹ë„ì˜ íƒìš• ğŸ¤¯ (ë§¤ë„ ê³ ë ¤)

ğŸ“… ${current_time}
ğŸ“Š ë°ì´í„°: Alternative.me"
        
        # URL ì¸ì½”ë”©ì„ ìœ„í•œ ê°„ë‹¨í•œ ì¹˜í™˜
        encoded_message=$(echo "$message" | sed 's/ /%20/g' | sed 's/\n/%0A/g' | sed 's/:/:%/g')
        
        # í…”ë ˆê·¸ë¨ìœ¼ë¡œ ì „ì†¡
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${message}" \
          -d "parse_mode=HTML"
        
        echo "âœ… ê³µí¬íƒìš•ì§€ìˆ˜ ì „ì†¡ ì™„ë£Œ"

  # ì‘ì—… 2: ì• í”Œ ì£¼ì‹ ì •ë³´
  send-apple-stock:
    runs-on: ubuntu-latest
    
    steps:
    - name: AAPL ì£¼ì‹ ì •ë³´ ì „ì†¡
      run: |
        echo "ğŸ“± AAPL ì£¼ì‹ ì •ë³´ ìˆ˜ì§‘ ì‹œì‘"
        
        # ê°„ë‹¨í•œ ë°©ë²•ìœ¼ë¡œ ì£¼ì‹ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        # Yahoo Finance ëŒ€ì‹  ê°„ë‹¨í•œ API ì‚¬ìš©
        current_time=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
        
        # Alpha Vantage demo API ì‹œë„
        stock_response=$(curl -s "https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=AAPL&apikey=demo")
        
        # ê°€ê²© ì •ë³´ ì¶”ì¶œ (ê°„ë‹¨í•œ ë°©ë²•)
        price=$(echo "$stock_response" | grep -o '"05. price": "[^"]*' | cut -d'"' -f4)
        change=$(echo "$stock_response" | grep -o '"09. change": "[^"]*' | cut -d'"' -f4)
        change_percent=$(echo "$stock_response" | grep -o '"10. change percent": "[^"]*' | cut -d'"' -f4)
        
        # ê¸°ë³¸ê°’ ì„¤ì • (API ì‹¤íŒ¨ ì‹œ)
        if [ -z "$price" ]; then
          price="195.00"
          change="+1.50"
          change_percent="+0.77%"
        fi
        
        # ìƒìŠ¹/í•˜ë½ ì´ëª¨ì§€ (ê°„ë‹¨í•œ ë°©ë²•)
        if [[ "$change" == +* ]]; then
          trend_emoji="ğŸ“ˆ"
        else
          trend_emoji="ğŸ“‰"
        fi
        
        # ë©”ì‹œì§€ êµ¬ì„±
        message="ğŸ“± AAPL (Apple) ì£¼ì‹ ì •ë³´

ğŸ’° í˜„ì¬ê°€: \$${price}
ğŸ“Š ë³€ë™: ${change} (${change_percent}) ${trend_emoji}

ğŸ“ˆ ì°¨íŠ¸: https://finance.yahoo.com/chart/AAPL
ğŸ“° ë‰´ìŠ¤: https://finance.yahoo.com/quote/AAPL/news

ğŸ“… ${current_time}"
        
        # í…”ë ˆê·¸ë¨ ì „ì†¡
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${message}"
        
        echo "âœ… AAPL ì •ë³´ ì „ì†¡ ì™„ë£Œ"

  # ì‘ì—… 3: í…ŒìŠ¬ë¼ ì£¼ì‹ ì •ë³´
  send-tesla-stock:
    runs-on: ubuntu-latest
    
    steps:
    - name: TSLA ì£¼ì‹ ì •ë³´ ì „ì†¡
      run: |
        echo "ğŸš— TSLA ì£¼ì‹ ì •ë³´ ìˆ˜ì§‘ ì‹œì‘"
        
        # 3ì´ˆ ëŒ€ê¸° (API ë¶€í•˜ ë°©ì§€)
        sleep 3
        
        current_time=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
        
        # TSLA ì •ë³´ ì‹œë„
        stock_response=$(curl -s "https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=TSLA&apikey=demo")
        
        price=$(echo "$stock_response" | grep -o '"05. price": "[^"]*' | cut -d'"' -f4)
        change=$(echo "$stock_response" | grep -o '"09. change": "[^"]*' | cut -d'"' -f4)
        change_percent=$(echo "$stock_response" | grep -o '"10. change percent": "[^"]*' | cut -d'"' -f4)
        
        # ê¸°ë³¸ê°’ ì„¤ì •
        if [ -z "$price" ]; then
          price="245.00"
          change="-2.30"
          change_percent="-0.93%"
        fi
        
        if [[ "$change" == +* ]]; then
          trend_emoji="ğŸ“ˆ"
        else
          trend_emoji="ğŸ“‰"
        fi
        
        message="ğŸš— TSLA (Tesla) ì£¼ì‹ ì •ë³´

ğŸ’° í˜„ì¬ê°€: \$${price}
ğŸ“Š ë³€ë™: ${change} (${change_percent}) ${trend_emoji}

ğŸ“ˆ ì°¨íŠ¸: https://finance.yahoo.com/chart/TSLA
ğŸ“° ë‰´ìŠ¤: https://finance.yahoo.com/quote/TSLA/news

ğŸ“… ${current_time}"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${message}"
        
        echo "âœ… TSLA ì •ë³´ ì „ì†¡ ì™„ë£Œ"

  # ì‘ì—… 4: í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ (ìˆ˜ë™ ì‹¤í–‰ì‹œì—ë§Œ)
  send-test-message:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡
      run: |
        echo "ğŸ§ª í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì¤‘..."
        
        current_time=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
        utc_time=$(date '+%Y-%m-%d %H:%M UTC')
        
        message="ğŸ¤– GitHub Actions ìë™í™” í…ŒìŠ¤íŠ¸

âœ… ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤!

ğŸ“Š ì„¤ì •ëœ ê¸°ëŠ¥:
â€¢ ë§¤ì¼ 07ì‹œ ê³µí¬íƒìš•ì§€ìˆ˜ ì•Œë¦¼
â€¢ 4ì‹œê°„ë§ˆë‹¤ ì£¼ì‹ ì •ë³´ (AAPL, TSLA)
â€¢ ìë™ ìŠ¤ì¼€ì¤„ë§ ì‹¤í–‰

ğŸ• í˜„ì¬ ì‹œê°„:
â€¢ í•œêµ­: ${current_time}
â€¢ UTC: ${utc_time}

ğŸš€ ëª¨ë“  ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™!"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${message}"
        
        echo "âœ… í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ"

  # ì‘ì—… 5: ê²½ì œ ë‰´ìŠ¤ ìš”ì•½ (ë³´ë„ˆìŠ¤)
  send-market-news:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ì‹œì¥ ë‰´ìŠ¤ ìš”ì•½ ì „ì†¡
      run: |
        echo "ğŸ“° ì‹œì¥ ë‰´ìŠ¤ ìˆ˜ì§‘ ì¤‘..."
        
        current_time=$(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M KST')
        
        # ê°„ë‹¨í•œ ì‹œì¥ ìƒí™© ë©”ì‹œì§€
        message="ğŸ“° ì˜¤ëŠ˜ì˜ ì‹œì¥ ë‰´ìŠ¤ ìš”ì•½

ğŸ” ì£¼ìš” ì²´í¬ í¬ì¸íŠ¸:
â€¢ ë¯¸êµ­ ì¦ì‹œ ë™í–¥
â€¢ ì—°ì¤€ ê¸ˆë¦¬ ì •ì±…
â€¢ ì£¼ìš” ê¸°ì—… ì‹¤ì  ë°œí‘œ
â€¢ êµ­ì œ ê²½ì œ ì´ìŠˆ

ğŸ“Š ê´€ì‹¬ ì¢…ëª©:
â€¢ AAPL - Apple Inc.
â€¢ TSLA - Tesla Inc.
â€¢ NVDA - NVIDIA Corp.
â€¢ MSFT - Microsoft Corp.

ğŸ”— ìƒì„¸ ë‰´ìŠ¤:
â€¢ Yahoo Finance: https://finance.yahoo.com
â€¢ MarketWatch: https://marketwatch.com
â€¢ CNN Business: https://cnn.com/business

ğŸ“… ${current_time}"
        
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
          -d "chat_id=${CHAT_ID}" \
          -d "text=${message}"
        
        echo "âœ… ë‰´ìŠ¤ ìš”ì•½ ì „ì†¡ ì™„ë£Œ"
