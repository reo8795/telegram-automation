name: Alternative Fear Greed with Data

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'      # ë§¤ì¼ 07:00 KST (ê³µí¬íƒìš•ì§€ìˆ˜)
    - cron: '0 */3 * * *'     # 3ì‹œê°„ë§ˆë‹¤ (ì¢…ëª© ë‰´ìŠ¤)

jobs:
  # ë§¤ì¼ ì•„ì¹¨ 7ì‹œ - ê³µí¬íƒìš•ì§€ìˆ˜ ë°ì´í„° + ì´ë¯¸ì§€
  morning-fear-greed-with-data:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 22 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Get Fear Greed Data and Send with Image
      run: |
        echo "ê³µí¬íƒìš•ì§€ìˆ˜ ë°ì´í„° ë° ì´ë¯¸ì§€ ì „ì†¡ ì‹œì‘"
        
        # 1ë‹¨ê³„: ì‹¤ì œ ê³µí¬íƒìš•ì§€ìˆ˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        echo "CNN APIì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œë„"
        cnn_data=$(curl -s "https://production.dataviz.cnn.io/index/fearandgreed/graphdata")
        
        if [ ! -z "$cnn_data" ] && echo "$cnn_data" | grep -q "fear_and_greed"; then
          # ì‹¤ì œ ë°ì´í„° íŒŒì‹±
          fear_greed_score=$(echo "$cnn_data" | grep -o '"score":[0-9]*' | head -1 | cut -d':' -f2)
          fear_greed_rating=$(echo "$cnn_data" | grep -o '"rating":"[^"]*' | head -1 | cut -d'"' -f4)
          last_updated=$(echo "$cnn_data" | grep -o '"timestamp":"[^"]*' | head -1 | cut -d'"' -f4)
          
          if [ ! -z "$fear_greed_score" ]; then
            echo "âœ… CNN ì‹¤ì œ ë°ì´í„° ìˆ˜ì‹ : $fear_greed_score ($fear_greed_rating)"
            
            # í•œê¸€ ìƒíƒœ ë³€í™˜
            case "$fear_greed_rating" in
              "Extreme Fear") korean_rating="ê·¹ë„ì˜ ê³µí¬" ;;
              "Fear") korean_rating="ê³µí¬" ;;
              "Neutral") korean_rating="ì¤‘ë¦½" ;;
              "Greed") korean_rating="íƒìš•" ;;
              "Extreme Greed") korean_rating="ê·¹ë„ì˜ íƒìš•" ;;
              *) korean_rating="$fear_greed_rating" ;;
            esac
            
            # ì´ëª¨ì§€ ì„ íƒ
            if [ "$fear_greed_score" -le 24 ]; then
              emoji="ğŸ˜±"
            elif [ "$fear_greed_score" -le 49 ]; then
              emoji="ğŸ˜°"
            elif [ "$fear_greed_score" -le 74 ]; then
              emoji="ğŸ¤‘"
            else
              emoji="ğŸ¤¯"
            fi
          else
            echo "âŒ CNN ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨"
            fear_greed_score="50"
            korean_rating="ì¤‘ë¦½"
            emoji="ğŸ˜"
          fi
        else
          echo "âŒ CNN API ì ‘ê·¼ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©"
          fear_greed_score="50"
          korean_rating="ì¤‘ë¦½" 
          emoji="ğŸ˜"
        fi
        
        # 2ë‹¨ê³„: ë‹¤ì–‘í•œ ì´ë¯¸ì§€ ì†ŒìŠ¤ ì‹œë„ (ìš°ì„ ìˆœìœ„ëŒ€ë¡œ)
        alternative_image_urls=(
          "https://production.dataviz.cnn.io/index/fearandgreed/chart"
          "https://images.financialcontent.com/feargreed.png"
          "https://www.marketwatch.com/investing/index/spx/charts"
          "https://charts.stocktwits.com/production/original_292836174.png"
          "https://pbs.twimg.com/media/fear-greed-index.jpg"
          "https://cdn.finviz.com/greed_fear_index.png"
          "https://www.investing.com/indices/us-spx-500-chart"
        )
        
        image_success=false
        
        # ê° ì´ë¯¸ì§€ URL ì‹œë„
        for url in "${alternative_image_urls[@]}"; do
          echo "ì´ë¯¸ì§€ ì‹œë„: $url"
          
          response=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendPhoto" \
            -F "chat_id=${{ secrets.CHAT_ID }}" \
            -F "photo=$url" \
            -F "caption=${emoji} CNN ë¯¸êµ­ ì£¼ì‹ ê³µí¬íƒìš•ì§€ìˆ˜

          ğŸ“Š í˜„ì¬ ì§€ìˆ˜: ${fear_greed_score}/100 (${korean_rating})

          ğŸ’¡ íˆ¬ì ê°€ì´ë“œ:
          ğŸ˜± 0-24: ê·¹ë„ì˜ ê³µí¬ (ë§¤ìˆ˜ ê¸°íšŒ)
          ğŸ˜° 25-49: ê³µí¬ (ì‹ ì¤‘í•œ ë§¤ìˆ˜)
          ğŸ¤‘ 50-74: íƒìš• (ì‹ ì¤‘í•œ ë§¤ë„)
          ğŸ¤¯ 75-100: ê·¹ë„ì˜ íƒìš• (ë§¤ë„ ê³ ë ¤)

          ğŸ“… $(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ 07:00 KST')
          ğŸ“Š ì‹¤ì‹œê°„: https://www.cnn.com/markets/fear-and-greed")
          
          if echo "$response" | grep -q '"ok":true'; then
            echo "âœ… ì´ë¯¸ì§€ ì „ì†¡ ì„±ê³µ: $url"
            image_success=true
            break
          else
            echo "âŒ ì´ë¯¸ì§€ ì‹¤íŒ¨: $url"
          fi
        done
        
        # 3ë‹¨ê³„: ëª¨ë“  ì´ë¯¸ì§€ ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ + ì°¨íŠ¸ ë§í¬
        if [ "$image_success" = false ]; then
          echo "ëª¨ë“  ì´ë¯¸ì§€ ì‹¤íŒ¨, í…ìŠ¤íŠ¸ë¡œ ì „ì†¡"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.CHAT_ID }}" \
            -d "text=${emoji} CNN ë¯¸êµ­ ì£¼ì‹ ê³µí¬íƒìš•ì§€ìˆ˜

          ğŸ“Š í˜„ì¬ ì§€ìˆ˜: ${fear_greed_score}/100 (${korean_rating})

          ğŸ’¡ íˆ¬ì ê°€ì´ë“œ:
          ğŸ˜± 0-24: ê·¹ë„ì˜ ê³µí¬ (ë§¤ìˆ˜ ê¸°íšŒ)
          ğŸ˜° 25-49: ê³µí¬ (ì‹ ì¤‘í•œ ë§¤ìˆ˜)
          ğŸ¤‘ 50-74: íƒìš• (ì‹ ì¤‘í•œ ë§¤ë„)
          ğŸ¤¯ 75-100: ê·¹ë„ì˜ íƒìš• (ë§¤ë„ ê³ ë ¤)

          ğŸ“… $(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ 07:00 KST')

          ğŸ“Š ì‹¤ì‹œê°„ ì°¨íŠ¸:
          ğŸ”— CNN: https://www.cnn.com/markets/fear-and-greed
          ğŸ“ˆ TradingView: https://www.tradingview.com/markets/stocks-usa/market-movers-overview/
          ğŸ“Š MarketWatch: https://www.marketwatch.com/investing/index/spx
          
          âš ï¸ ì´ë¯¸ì§€ ì „ì†¡ ë¶ˆê°€ë¡œ ë§í¬ì—ì„œ í™•ì¸í•´ì£¼ì„¸ìš”"
        fi
        
        echo "ê³µí¬íƒìš•ì§€ìˆ˜ ì „ì†¡ ì™„ë£Œ: ${fear_greed_score}/100 (${korean_rating})"

    - name: Send VIX Alternative
      run: |
        sleep 3
        echo "VIX ì§€ìˆ˜ ëŒ€ì•ˆ ì •ë³´ ì „ì†¡"
        
        # VIX ì§€ìˆ˜ë¡œ ì‹œì¥ ì‹¬ë¦¬ ë³´ì™„ ì •ë³´
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}" \
          -d "text=ğŸ“ˆ ì¶”ê°€ ì‹œì¥ ì‹¬ë¦¬ ì§€í‘œ

        ğŸ“Š VIX (ê³µí¬ì§€ìˆ˜) í™•ì¸:
        ğŸ”— https://finance.yahoo.com/quote/%5EVIX

        ğŸ“ˆ S&P 500 ì§€ìˆ˜:
        ğŸ”— https://finance.yahoo.com/quote/%5EGSPC

        ğŸ’¡ ì°¸ê³ :
        â€¢ VIX 20 ì´í•˜ = ì‹œì¥ ì•ˆì •
        â€¢ VIX 20-30 = ë³´í†µ ë¶ˆì•ˆ
        â€¢ VIX 30 ì´ìƒ = ë†’ì€ ë¶ˆì•ˆ

        ğŸ“… $(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ 07:00 KST')"

  # 3ì‹œê°„ë§ˆë‹¤ - ì¢…ëª© ë‰´ìŠ¤ (ê¸°ì¡´ê³¼ ë™ì¼)
  korean-translated-news:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 */3 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Get News and Translate to Korean
      run: |
        echo "ì¢…ëª© ë‰´ìŠ¤ í™•ì¸ ë° í•œêµ­ì–´ ë²ˆì—­ ì‹œì‘"
        
        # ì¢…ëª© ë¦¬ìŠ¤íŠ¸
        declare -A stocks=(
          ["CRCL"]="Circle Internet Group"
          ["OSCR"]="Oscar Health"
          ["ARQQ"]="Arqit Quantum"
          ["BTM"]="Bitcoin Depot"
          ["CRWV"]="CoreWeave"
          ["GLXY"]="Galaxy Digital"
          ["NBIS"]="Nebius Group"
          ["TSLA"]="Tesla"
          ["OKLO"]="Oklo"
          ["MRVL"]="Marvell Technology"
          ["PLTR"]="Palantir"
          ["AEVA"]="Aeva Technologies"
        )
        
        # ë²ˆì—­ í•¨ìˆ˜
        translate_to_korean() {
          local english_text="$1"
          korean_text="$english_text"
          
          # ì£¼ì‹ ìš©ì–´ ë²ˆì—­
          korean_text=$(echo "$korean_text" | sed 's/\bstock\b/ì£¼ì‹/g')
          korean_text=$(echo "$korean_text" | sed 's/\bshares\b/ì£¼ì‹/g')
          korean_text=$(echo "$korean_text" | sed 's/\bearnings\b/ì‹¤ì /g')
          korean_text=$(echo "$korean_text" | sed 's/\brevenue\b/ë§¤ì¶œ/g')
          korean_text=$(echo "$korean_text" | sed 's/\bprofit\b/ì´ìµ/g')
          korean_text=$(echo "$korean_text" | sed 's/\bgains\b/ìƒìŠ¹/g')
          korean_text=$(echo "$korean_text" | sed 's/\bfalls\b/í•˜ë½/g')
          korean_text=$(echo "$korean_text" | sed 's/\brises\b/ìƒìŠ¹/g')
          korean_text=$(echo "$korean_text" | sed 's/\bdrops\b/í•˜ë½/g')
          korean_text=$(echo "$korean_text" | sed 's/\bsurges\b/ê¸‰ë“±/g')
          korean_text=$(echo "$korean_text" | sed 's/\bplunges\b/ê¸‰ë½/g')
          korean_text=$(echo "$korean_text" | sed 's/\binvestment\b/íˆ¬ì/g')
          korean_text=$(echo "$korean_text" | sed 's/\bmarket\b/ì‹œì¥/g')
          korean_text=$(echo "$korean_text" | sed 's/\bcompany\b/íšŒì‚¬/g')
          korean_text=$(echo "$korean_text" | sed 's/\bquarter\b/ë¶„ê¸°/g')
          korean_text=$(echo "$korean_text" | sed 's/\banalyst\b/ì• ë„ë¦¬ìŠ¤íŠ¸/g')
          korean_text=$(echo "$korean_text" | sed 's/\btarget\b/ëª©í‘œê°€/g')
          korean_text=$(echo "$korean_text" | sed 's/\bupgrade\b/ìƒí–¥ì¡°ì •/g')
          korean_text=$(echo "$korean_text" | sed 's/\bdowngrade\b/í•˜í–¥ì¡°ì •/g')
          korean_text=$(echo "$korean_text" | sed 's/\bbuy\b/ë§¤ìˆ˜/g')
          korean_text=$(echo "$korean_text" | sed 's/\bsell\b/ë§¤ë„/g')
          korean_text=$(echo "$korean_text" | sed 's/\bhold\b/ë³´ìœ /g')
          
          # íšŒì‚¬ë³„ ë²ˆì—­
          korean_text=$(echo "$korean_text" | sed 's/\bTesla\b/í…ŒìŠ¬ë¼/g')
          korean_text=$(echo "$korean_text" | sed 's/\bPalantir\b/íŒ”ë€í‹°ì–´/g')
          korean_text=$(echo "$korean_text" | sed 's/\bMarvell\b/ë§ˆë²¨/g')
          korean_text=$(echo "$korean_text" | sed 's/\belectric vehicle\b/ì „ê¸°ì°¨/g')
          korean_text=$(echo "$korean_text" | sed 's/\bEV\b/ì „ê¸°ì°¨/g')
          korean_text=$(echo "$korean_text" | sed 's/\bautonomous\b/ììœ¨ì£¼í–‰/g')
          korean_text=$(echo "$korean_text" | sed 's/\bAI\b/AI/g')
          korean_text=$(echo "$korean_text" | sed 's/\bartificial intelligence\b/ì¸ê³µì§€ëŠ¥/g')
          korean_text=$(echo "$korean_text" | sed 's/\bbitcoin\b/ë¹„íŠ¸ì½”ì¸/g')
          korean_text=$(echo "$korean_text" | sed 's/\bcryptocurrency\b/ì•”í˜¸í™”í/g')
          korean_text=$(echo "$korean_text" | sed 's/\bblockchain\b/ë¸”ë¡ì²´ì¸/g')
          korean_text=$(echo "$korean_text" | sed 's/\bquantum\b/ì–‘ì/g')
          korean_text=$(echo "$korean_text" | sed 's/\bcloud\b/í´ë¼ìš°ë“œ/g')
          korean_text=$(echo "$korean_text" | sed 's/\bsemiconductor\b/ë°˜ë„ì²´/g')
          korean_text=$(echo "$korean_text" | sed 's/\bchip\b/ì¹©/g')
          
          echo "$korean_text"
        }
        
        # ë„¤ì´ë²„ ë‰´ìŠ¤ í™•ì¸
        naver_news=$(curl -s "https://news.google.com/rss/search?q=NAVER+Korea+stock+ë„¤ì´ë²„+ì£¼ì‹" | head -20)
        naver_title=$(echo "$naver_news" | grep -o '<title><!\[CDATA\[.*\]\]></title>' | head -2 | tail -1 | sed 's/<title><!\[CDATA\[//g' | sed 's/\]\]><\/title>//g')
        
        if [ ! -z "$naver_title" ] && [ "$naver_title" != "" ] && [ "$naver_title" != "Google News" ]; then
          if echo "$naver_title" | grep -q '[ê°€-í£]'; then
            translated_title="$naver_title"
          else
            translated_title=$(translate_to_korean "$naver_title")
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.CHAT_ID }}" \
            -d "text=ğŸ‡°ğŸ‡· NAVER (035420) ìµœì‹  ë‰´ìŠ¤

          ğŸ“° ${translated_title}

          ğŸ”— ë‰´ìŠ¤ ë§í¬: https://news.google.com/search?q=NAVER+Korea
          ğŸ“Š ì£¼ê°€ í™•ì¸: https://finance.yahoo.com/quote/035420.KS

          ğŸ“… $(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ %H:%M KST')"
        fi
        
        # ë¯¸êµ­ ì¢…ëª©ë“¤ ë‰´ìŠ¤ í™•ì¸
        for symbol in "${!stocks[@]}"; do
          company_name="${stocks[$symbol]}"
          echo "ë‰´ìŠ¤ í™•ì¸: $symbol ($company_name)"
          
          news_data=$(curl -s "https://news.google.com/rss/search?q=${symbol}+${company_name// /+}+stock+news" | head -20)
          english_title=$(echo "$news_data" | grep -o '<title><!\[CDATA\[.*\]\]></title>' | head -2 | tail -1 | sed 's/<title><!\[CDATA\[//g' | sed 's/\]\]><\/title>//g')
          
          if [ ! -z "$english_title" ] && [ "$english_title" != "" ] && [ "$english_title" != "Google News" ]; then
            korean_title=$(translate_to_korean "$english_title")
            news_link="https://news.google.com/search?q=${symbol}+${company_name// /+}+stock"
            
            case "$symbol" in
              "TSLA") emoji="ğŸš—" ;;
              "PLTR") emoji="ğŸ”" ;;
              "MRVL") emoji="ğŸ’" ;;
              "BTM") emoji="â‚¿" ;;
              "GLXY") emoji="ğŸŒŒ" ;;
              "OSCR") emoji="ğŸ¥" ;;
              "OKLO") emoji="âš›ï¸" ;;
              "AEVA") emoji="ğŸ“¡" ;;
              "NBIS") emoji="ğŸ”¬" ;;
              "ARQQ") emoji="âš›ï¸" ;;
              "CRCL") emoji="ğŸŒ" ;;
              "CRWV") emoji="â˜ï¸" ;;
              *) emoji="ğŸ“ˆ" ;;
            esac
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.CHAT_ID }}" \
              -d "text=${emoji} ${symbol} (${company_name}) ìµœì‹  ë‰´ìŠ¤

            ğŸ“° ${korean_title}

            ğŸ”— ë‰´ìŠ¤ ë§í¬: ${news_link}
            ğŸ“Š ì£¼ê°€ í™•ì¸: https://finance.yahoo.com/quote/${symbol}

            ğŸ“… $(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ %H:%M KST')"
            
            sleep 3
          fi
          
          sleep 1
        done
