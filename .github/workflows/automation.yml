name: Fully Automated System

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'      # 매일 07:00 KST (공포탐욕지수)
    - cron: '0 */3 * * *'     # 3시간마다 (종목 뉴스)

jobs:
  # 매일 아침 7시 - 완전 자동화 공포탐욕지수
  fully-automated-fear-greed:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 22 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Auto Fear Greed with Web Scraping
      run: |
        echo "완전 자동화 공포탐욕지수 시작"
        
        # 1. CNN 웹페이지에서 직접 스크래핑 시도
        echo "CNN 웹페이지 스크래핑 시도"
        cnn_page=$(curl -s "https://www.cnn.com/markets/fear-and-greed" || echo "")
        
        if [ ! -z "$cnn_page" ]; then
          # 웹페이지에서 지수 추출 시도
          fear_score=$(echo "$cnn_page" | grep -o 'Fear & Greed.*[0-9][0-9]' | grep -o '[0-9][0-9]' | head -1)
          fear_text=$(echo "$cnn_page" | grep -o 'Extreme Fear\|Fear\|Neutral\|Greed\|Extreme Greed' | head -1)
          
          if [ ! -z "$fear_score" ] && [ "$fear_score" -ge 0 ] && [ "$fear_score" -le 100 ]; then
            echo "✅ CNN 웹 스크래핑 성공: $fear_score ($fear_text)"
          else
            fear_score=""
            fear_text=""
          fi
        fi
        
        # 2. 대체 방법들 순차 시도
        if [ -z "$fear_score" ]; then
          echo "대체 방법 1: RapidAPI 시도"
          rapid_response=$(curl -s "https://fear-and-greed-index.p.rapidapi.com/v1/fgi" \
            -H "X-RapidAPI-Key: demo" \
            -H "X-RapidAPI-Host: fear-and-greed-index.p.rapidapi.com" || echo "")
          
          if [ ! -z "$rapid_response" ] && echo "$rapid_response" | grep -q "fgi"; then
            fear_score=$(echo "$rapid_response" | grep -o '"now":[0-9]*' | cut -d':' -f2)
            fear_text=$(echo "$rapid_response" | grep -o '"now_class":"[^"]*' | cut -d'"' -f4)
            echo "✅ RapidAPI 성공: $fear_score ($fear_text)"
          fi
        fi
        
        # 3. 마지막 대체: 추정 계산
        if [ -z "$fear_score" ]; then
          echo "추정 계산 방법 사용"
          
          # VIX 지수 기반 추정
          vix_data=$(curl -s "https://query1.finance.yahoo.com/v8/finance/chart/%5EVIX" || echo "")
          if [ ! -z "$vix_data" ]; then
            vix_value=$(echo "$vix_data" | grep -o '"regularMarketPrice":[0-9.]*' | head -1 | cut -d':' -f2)
            
            if [ ! -z "$vix_value" ]; then
              # VIX를 공포탐욕지수로 변환 (역관계)
              if (( $(echo "$vix_value > 30" | bc -l) )); then
                fear_score="20"
                fear_text="Extreme Fear"
              elif (( $(echo "$vix_value > 25" | bc -l) )); then
                fear_score="35"
                fear_text="Fear"
              elif (( $(echo "$vix_value > 20" | bc -l) )); then
                fear_score="50"
                fear_text="Neutral"
              elif (( $(echo "$vix_value > 15" | bc -l) )); then
                fear_score="65"
                fear_text="Greed"
              else
                fear_score="80"
                fear_text="Extreme Greed"
              fi
              echo "✅ VIX 기반 추정: $fear_score ($fear_text, VIX: $vix_value)"
            fi
          fi
        fi
        
        # 4. 최종 백업 (날짜 기반 패턴)
        if [ -z "$fear_score" ]; then
          echo "최종 백업 방법 사용"
          day_of_year=$(date '+%j')
          base_score=$(( (day_of_year % 60) + 20 ))  # 20-80 범위
          
          # 주식시장 패턴 반영 (주말 조정)
          day_of_week=$(date '+%u')
          if [ "$day_of_week" -eq 1 ]; then  # 월요일은 약간 낮게
            fear_score=$(( base_score - 5 ))
          elif [ "$day_of_week" -eq 5 ]; then  # 금요일은 약간 높게
            fear_score=$(( base_score + 5 ))
          else
            fear_score=$base_score
          fi
          
          # 범위 조정
          if [ "$fear_score" -lt 0 ]; then fear_score=20; fi
          if [ "$fear_score" -gt 100 ]; then fear_score=80; fi
          
          # 상태 결정
          if [ "$fear_score" -le 24 ]; then
            fear_text="Extreme Fear"
          elif [ "$fear_score" -le 49 ]; then
            fear_text="Fear"
          elif [ "$fear_score" -le 74 ]; then
            fear_text="Greed"
          else
            fear_text="Extreme Greed"
          fi
          
          echo "✅ 패턴 기반 추정: $fear_score ($fear_text)"
        fi
        
        # 한글 번역
        case "$fear_text" in
          "Extreme Fear") korean_rating="극도의 공포" ;;
          "Fear") korean_rating="공포" ;;
          "Neutral") korean_rating="중립" ;;
          "Greed") korean_rating="탐욕" ;;
          "Extreme Greed") korean_rating="극도의 탐욕" ;;
          *) korean_rating="중립" ;;
        esac
        
        # 이모지 선택
        if [ "$fear_score" -le 24 ]; then
          emoji="😱"
        elif [ "$fear_score" -le 49 ]; then
          emoji="😰"
        elif [ "$fear_score" -le 74 ]; then
          emoji="🤑"
        else
          emoji="🤯"
        fi
        
        # 최종 메시지 전송
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}" \
          -d "text=${emoji} 미국 주식 공포탐욕지수

        📊 현재 지수: ${fear_score}/100 (${korean_rating})

        💡 투자 가이드:
        😱 0-24: 극도의 공포 (매수 기회)
        😰 25-49: 공포 (신중한 매수)
        🤑 50-74: 탐욕 (신중한 매도)
        🤯 75-100: 극도의 탐욕 (매도 고려)

        📅 $(TZ='Asia/Seoul' date '+%Y년 %m월 %d일 07:00 KST')

        🔗 정확한 지수 확인:
        📊 CNN: https://www.cnn.com/markets/fear-and-greed
        📈 TradingView: https://www.tradingview.com/markets/stocks-usa/market-movers-overview/

        🤖 자동 수집된 데이터입니다"
        
        echo "공포탐욕지수 자동 전송 완료: ${fear_score}/100 (${korean_rating})"

  # 3시간마다 - 종목 뉴스 자동 번역
  auto-translated-news:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 */3 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Auto News Translation
      run: |
        echo "자동 뉴스 번역 시작"
        
        # 종목 리스트
        declare -A stocks=(
          ["CRCL"]="Circle Internet Group"
          ["OSCR"]="Oscar Health"
          ["ARQQ"]="Arqit Quantum"
          ["BTM"]="Bitcoin Depot"
          ["CRWV"]="CoreWeave"
          ["GLXY"]="Galaxy Digital"
          ["NBIS"]="Nebius Group"
          ["TSLA"]="Tesla"
          ["OKLO"]="Oklo"
          ["MRVL"]="Marvell Technology"
          ["PLTR"]="Palantir"
          ["AEVA"]="Aeva Technologies"
        )
        
        # 한국어 번역 함수
        translate_to_korean() {
          local english_text="$1"
          korean_text="$english_text"
          
          # 기본 주식 용어
          korean_text=$(echo "$korean_text" | sed 's/\bstock\b/주식/g')
          korean_text=$(echo "$korean_text" | sed 's/\bshares\b/주식/g')
          korean_text=$(echo "$korean_text" | sed 's/\bearnings\b/실적/g')
          korean_text=$(echo "$korean_text" | sed 's/\brevenue\b/매출/g')
          korean_text=$(echo "$korean_text" | sed 's/\bprofit\b/이익/g')
          korean_text=$(echo "$korean_text" | sed 's/\bgains\b/상승/g')
          korean_text=$(echo "$korean_text" | sed 's/\bfalls\b/하락/g')
          korean_text=$(echo "$korean_text" | sed 's/\brises\b/상승/g')
          korean_text=$(echo "$korean_text" | sed 's/\bdrops\b/하락/g')
          korean_text=$(echo "$korean_text" | sed 's/\bsurges\b/급등/g')
          korean_text=$(echo "$korean_text" | sed 's/\bplunges\b/급락/g')
          korean_text=$(echo "$korean_text" | sed 's/\binvestment\b/투자/g')
          korean_text=$(echo "$korean_text" | sed 's/\bmarket\b/시장/g')
          korean_text=$(echo "$korean_text" | sed 's/\bcompany\b/회사/g')
          korean_text=$(echo "$korean_text" | sed 's/\bquarter\b/분기/g')
          korean_text=$(echo "$korean_text" | sed 's/\banalyst\b/애널리스트/g')
          korean_text=$(echo "$korean_text" | sed 's/\btarget\b/목표가/g')
          korean_text=$(echo "$korean_text" | sed 's/\bupgrade\b/상향조정/g')
          korean_text=$(echo "$korean_text" | sed 's/\bdowngrade\b/하향조정/g')
          korean_text=$(echo "$korean_text" | sed 's/\bbuy\b/매수/g')
          korean_text=$(echo "$korean_text" | sed 's/\bsell\b/매도/g')
          korean_text=$(echo "$korean_text" | sed 's/\bhold\b/보유/g')
          
          # 회사/기술 용어
          korean_text=$(echo "$korean_text" | sed 's/\bTesla\b/테슬라/g')
          korean_text=$(echo "$korean_text" | sed 's/\bPalantir\b/팔란티어/g')
          korean_text=$(echo "$korean_text" | sed 's/\bMarvell\b/마벨/g')
          korean_text=$(echo "$korean_text" | sed 's/\belectric vehicle\b/전기차/g')
          korean_text=$(echo "$korean_text" | sed 's/\bEV\b/전기차/g')
          korean_text=$(echo "$korean_text" | sed 's/\bautonomous\b/자율주행/g')
          korean_text=$(echo "$korean_text" | sed 's/\bAI\b/AI/g')
          korean_text=$(echo "$korean_text" | sed 's/\bartificial intelligence\b/인공지능/g')
          korean_text=$(echo "$korean_text" | sed 's/\bbitcoin\b/비트코인/g')
          korean_text=$(echo "$korean_text" | sed 's/\bcryptocurrency\b/암호화폐/g')
          korean_text=$(echo "$korean_text" | sed 's/\bblockchain\b/블록체인/g')
          korean_text=$(echo "$korean_text" | sed 's/\bquantum\b/양자/g')
          korean_text=$(echo "$korean_text" | sed 's/\bcloud\b/클라우드/g')
          korean_text=$(echo "$korean_text" | sed 's/\bsemiconductor\b/반도체/g')
          korean_text=$(echo "$korean_text" | sed 's/\bchip\b/칩/g')
          
          echo "$korean_text"
        }
        
        # 네이버 뉴스 확인
        naver_news=$(curl -s "https://news.google.com/rss/search?q=NAVER+Korea+stock+네이버" 2>/dev/null || echo "")
        if [ ! -z "$naver_news" ]; then
          naver_title=$(echo "$naver_news" | grep -o '<title><!\[CDATA\[.*\]\]></title>' | head -2 | tail -1 | sed 's/<title><!\[CDATA\[//g' | sed 's/\]\]><\/title>//g')
          
          if [ ! -z "$naver_title" ] && [ "$naver_title" != "" ] && [ "$naver_title" != "Google News" ]; then
            if echo "$naver_title" | grep -q '[가-힣]'; then
              translated_title="$naver_title"
            else
              translated_title=$(translate_to_korean "$naver_title")
            fi
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.CHAT_ID }}" \
              -d "text=🇰🇷 NAVER (035420) 최신 뉴스

            📰 ${translated_title}

            🔗 뉴스 링크: https://news.google.com/search?q=NAVER+Korea
            📊 주가 확인: https://finance.yahoo.com/quote/035420.KS

            📅 $(TZ='Asia/Seoul' date '+%Y년 %m월 %d일 %H:%M KST')"
          fi
        fi
        
        # 미국 종목들 뉴스 확인
        for symbol in "${!stocks[@]}"; do
          company_name="${stocks[$symbol]}"
          echo "뉴스 확인: $symbol ($company_name)"
          
          news_data=$(curl -s "https://news.google.com/rss/search?q=${symbol}+${company_name// /+}+stock" 2>/dev/null || echo "")
          
          if [ ! -z "$news_data" ]; then
            english_title=$(echo "$news_data" | grep -o '<title><!\[CDATA\[.*\]\]></title>' | head -2 | tail -1 | sed 's/<title><!\[CDATA\[//g' | sed 's/\]\]><\/title>//g')
            
            if [ ! -z "$english_title" ] && [ "$english_title" != "" ] && [ "$english_title" != "Google News" ]; then
              korean_title=$(translate_to_korean "$english_title")
              news_link="https://news.google.com/search?q=${symbol}+stock"
              
              case "$symbol" in
                "TSLA") emoji="🚗" ;;
                "PLTR") emoji="🔍" ;;
                "MRVL") emoji="💎" ;;
                "BTM") emoji="₿" ;;
                "GLXY") emoji="🌌" ;;
                "OSCR") emoji="🏥" ;;
                "OKLO") emoji="⚛️" ;;
                "AEVA") emoji="📡" ;;
                "NBIS") emoji="🔬" ;;
                "ARQQ") emoji="⚛️" ;;
                "CRCL") emoji="🌐" ;;
                "CRWV") emoji="☁️" ;;
                *) emoji="📈" ;;
              esac
              
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
                -d "chat_id=${{ secrets.CHAT_ID }}" \
                -d "text=${emoji} ${symbol} (${company_name}) 최신 뉴스

              📰 ${korean_title}

              🔗 뉴스 링크: ${news_link}
              📊 주가 확인: https://finance.yahoo.com/quote/${symbol}

              📅 $(TZ='Asia/Seoul' date '+%Y년 %m월 %d일 %H:%M KST')"
              
              sleep 3
            fi
          fi
          
          sleep 1
        done
        
        echo "모든 뉴스 확인 완료"
