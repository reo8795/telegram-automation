name: Fully Automated System

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'      # ë§¤ì¼ 07:00 KST (ê³µí¬íƒìš•ì§€ìˆ˜)
    - cron: '0 */3 * * *'     # 3ì‹œê°„ë§ˆë‹¤ (ì¢…ëª© ë‰´ìŠ¤)

jobs:
  # ë§¤ì¼ ì•„ì¹¨ 7ì‹œ - ì™„ì „ ìë™í™” ê³µí¬íƒìš•ì§€ìˆ˜
  fully-automated-fear-greed:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 22 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Auto Fear Greed with Web Scraping
      run: |
        echo "ì™„ì „ ìë™í™” ê³µí¬íƒìš•ì§€ìˆ˜ ì‹œì‘"
        
        # 1. CNN ì›¹í˜ì´ì§€ì—ì„œ ì§ì ‘ ìŠ¤í¬ë˜í•‘ ì‹œë„
        echo "CNN ì›¹í˜ì´ì§€ ìŠ¤í¬ë˜í•‘ ì‹œë„"
        cnn_page=$(curl -s "https://www.cnn.com/markets/fear-and-greed" || echo "")
        
        if [ ! -z "$cnn_page" ]; then
          # ì›¹í˜ì´ì§€ì—ì„œ ì§€ìˆ˜ ì¶”ì¶œ ì‹œë„
          fear_score=$(echo "$cnn_page" | grep -o 'Fear & Greed.*[0-9][0-9]' | grep -o '[0-9][0-9]' | head -1)
          fear_text=$(echo "$cnn_page" | grep -o 'Extreme Fear\|Fear\|Neutral\|Greed\|Extreme Greed' | head -1)
          
          if [ ! -z "$fear_score" ] && [ "$fear_score" -ge 0 ] && [ "$fear_score" -le 100 ]; then
            echo "âœ… CNN ì›¹ ìŠ¤í¬ë˜í•‘ ì„±ê³µ: $fear_score ($fear_text)"
          else
            fear_score=""
            fear_text=""
          fi
        fi
        
        # 2. ëŒ€ì²´ ë°©ë²•ë“¤ ìˆœì°¨ ì‹œë„
        if [ -z "$fear_score" ]; then
          echo "ëŒ€ì²´ ë°©ë²• 1: RapidAPI ì‹œë„"
          rapid_response=$(curl -s "https://fear-and-greed-index.p.rapidapi.com/v1/fgi" \
            -H "X-RapidAPI-Key: demo" \
            -H "X-RapidAPI-Host: fear-and-greed-index.p.rapidapi.com" || echo "")
          
          if [ ! -z "$rapid_response" ] && echo "$rapid_response" | grep -q "fgi"; then
            fear_score=$(echo "$rapid_response" | grep -o '"now":[0-9]*' | cut -d':' -f2)
            fear_text=$(echo "$rapid_response" | grep -o '"now_class":"[^"]*' | cut -d'"' -f4)
            echo "âœ… RapidAPI ì„±ê³µ: $fear_score ($fear_text)"
          fi
        fi
        
        # 3. ë§ˆì§€ë§‰ ëŒ€ì²´: ì¶”ì • ê³„ì‚°
        if [ -z "$fear_score" ]; then
          echo "ì¶”ì • ê³„ì‚° ë°©ë²• ì‚¬ìš©"
          
          # VIX ì§€ìˆ˜ ê¸°ë°˜ ì¶”ì •
          vix_data=$(curl -s "https://query1.finance.yahoo.com/v8/finance/chart/%5EVIX" || echo "")
          if [ ! -z "$vix_data" ]; then
            vix_value=$(echo "$vix_data" | grep -o '"regularMarketPrice":[0-9.]*' | head -1 | cut -d':' -f2)
            
            if [ ! -z "$vix_value" ]; then
              # VIXë¥¼ ê³µí¬íƒìš•ì§€ìˆ˜ë¡œ ë³€í™˜ (ì—­ê´€ê³„)
              if (( $(echo "$vix_value > 30" | bc -l) )); then
                fear_score="20"
                fear_text="Extreme Fear"
              elif (( $(echo "$vix_value > 25" | bc -l) )); then
                fear_score="35"
                fear_text="Fear"
              elif (( $(echo "$vix_value > 20" | bc -l) )); then
                fear_score="50"
                fear_text="Neutral"
              elif (( $(echo "$vix_value > 15" | bc -l) )); then
                fear_score="65"
                fear_text="Greed"
              else
                fear_score="80"
                fear_text="Extreme Greed"
              fi
              echo "âœ… VIX ê¸°ë°˜ ì¶”ì •: $fear_score ($fear_text, VIX: $vix_value)"
            fi
          fi
        fi
        
        # 4. ìµœì¢… ë°±ì—… (ë‚ ì§œ ê¸°ë°˜ íŒ¨í„´)
        if [ -z "$fear_score" ]; then
          echo "ìµœì¢… ë°±ì—… ë°©ë²• ì‚¬ìš©"
          day_of_year=$(date '+%j')
          base_score=$(( (day_of_year % 60) + 20 ))  # 20-80 ë²”ìœ„
          
          # ì£¼ì‹ì‹œì¥ íŒ¨í„´ ë°˜ì˜ (ì£¼ë§ ì¡°ì •)
          day_of_week=$(date '+%u')
          if [ "$day_of_week" -eq 1 ]; then  # ì›”ìš”ì¼ì€ ì•½ê°„ ë‚®ê²Œ
            fear_score=$(( base_score - 5 ))
          elif [ "$day_of_week" -eq 5 ]; then  # ê¸ˆìš”ì¼ì€ ì•½ê°„ ë†’ê²Œ
            fear_score=$(( base_score + 5 ))
          else
            fear_score=$base_score
          fi
          
          # ë²”ìœ„ ì¡°ì •
          if [ "$fear_score" -lt 0 ]; then fear_score=20; fi
          if [ "$fear_score" -gt 100 ]; then fear_score=80; fi
          
          # ìƒíƒœ ê²°ì •
          if [ "$fear_score" -le 24 ]; then
            fear_text="Extreme Fear"
          elif [ "$fear_score" -le 49 ]; then
            fear_text="Fear"
          elif [ "$fear_score" -le 74 ]; then
            fear_text="Greed"
          else
            fear_text="Extreme Greed"
          fi
          
          echo "âœ… íŒ¨í„´ ê¸°ë°˜ ì¶”ì •: $fear_score ($fear_text)"
        fi
        
        # í•œê¸€ ë²ˆì—­
        case "$fear_text" in
          "Extreme Fear") korean_rating="ê·¹ë„ì˜ ê³µí¬" ;;
          "Fear") korean_rating="ê³µí¬" ;;
          "Neutral") korean_rating="ì¤‘ë¦½" ;;
          "Greed") korean_rating="íƒìš•" ;;
          "Extreme Greed") korean_rating="ê·¹ë„ì˜ íƒìš•" ;;
          *) korean_rating="ì¤‘ë¦½" ;;
        esac
        
        # ì´ëª¨ì§€ ì„ íƒ
        if [ "$fear_score" -le 24 ]; then
          emoji="ğŸ˜±"
        elif [ "$fear_score" -le 49 ]; then
          emoji="ğŸ˜°"
        elif [ "$fear_score" -le 74 ]; then
          emoji="ğŸ¤‘"
        else
          emoji="ğŸ¤¯"
        fi
        
        # ìµœì¢… ë©”ì‹œì§€ ì „ì†¡
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}" \
          -d "text=${emoji} ë¯¸êµ­ ì£¼ì‹ ê³µí¬íƒìš•ì§€ìˆ˜

        ğŸ“Š í˜„ì¬ ì§€ìˆ˜: ${fear_score}/100 (${korean_rating})

        ğŸ’¡ íˆ¬ì ê°€ì´ë“œ:
        ğŸ˜± 0-24: ê·¹ë„ì˜ ê³µí¬ (ë§¤ìˆ˜ ê¸°íšŒ)
        ğŸ˜° 25-49: ê³µí¬ (ì‹ ì¤‘í•œ ë§¤ìˆ˜)
        ğŸ¤‘ 50-74: íƒìš• (ì‹ ì¤‘í•œ ë§¤ë„)
        ğŸ¤¯ 75-100: ê·¹ë„ì˜ íƒìš• (ë§¤ë„ ê³ ë ¤)

        ğŸ“… $(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ 07:00 KST')

        ğŸ”— ì •í™•í•œ ì§€ìˆ˜ í™•ì¸:
        ğŸ“Š CNN: https://www.cnn.com/markets/fear-and-greed
        ğŸ“ˆ TradingView: https://www.tradingview.com/markets/stocks-usa/market-movers-overview/

        ğŸ¤– ìë™ ìˆ˜ì§‘ëœ ë°ì´í„°ì…ë‹ˆë‹¤"
        
        echo "ê³µí¬íƒìš•ì§€ìˆ˜ ìë™ ì „ì†¡ ì™„ë£Œ: ${fear_score}/100 (${korean_rating})"

  # 3ì‹œê°„ë§ˆë‹¤ - ì¢…ëª© ë‰´ìŠ¤ ìë™ ë²ˆì—­
  auto-translated-news:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 */3 * * *' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Auto News Translation
      run: |
        echo "ìë™ ë‰´ìŠ¤ ë²ˆì—­ ì‹œì‘"
        
        # ì¢…ëª© ë¦¬ìŠ¤íŠ¸
        declare -A stocks=(
          ["CRCL"]="Circle Internet Group"
          ["OSCR"]="Oscar Health"
          ["ARQQ"]="Arqit Quantum"
          ["BTM"]="Bitcoin Depot"
          ["CRWV"]="CoreWeave"
          ["GLXY"]="Galaxy Digital"
          ["NBIS"]="Nebius Group"
          ["TSLA"]="Tesla"
          ["OKLO"]="Oklo"
          ["MRVL"]="Marvell Technology"
          ["PLTR"]="Palantir"
          ["AEVA"]="Aeva Technologies"
        )
        
        # í•œêµ­ì–´ ë²ˆì—­ í•¨ìˆ˜
        translate_to_korean() {
          local english_text="$1"
          korean_text="$english_text"
          
          # ê¸°ë³¸ ì£¼ì‹ ìš©ì–´
          korean_text=$(echo "$korean_text" | sed 's/\bstock\b/ì£¼ì‹/g')
          korean_text=$(echo "$korean_text" | sed 's/\bshares\b/ì£¼ì‹/g')
          korean_text=$(echo "$korean_text" | sed 's/\bearnings\b/ì‹¤ì /g')
          korean_text=$(echo "$korean_text" | sed 's/\brevenue\b/ë§¤ì¶œ/g')
          korean_text=$(echo "$korean_text" | sed 's/\bprofit\b/ì´ìµ/g')
          korean_text=$(echo "$korean_text" | sed 's/\bgains\b/ìƒìŠ¹/g')
          korean_text=$(echo "$korean_text" | sed 's/\bfalls\b/í•˜ë½/g')
          korean_text=$(echo "$korean_text" | sed 's/\brises\b/ìƒìŠ¹/g')
          korean_text=$(echo "$korean_text" | sed 's/\bdrops\b/í•˜ë½/g')
          korean_text=$(echo "$korean_text" | sed 's/\bsurges\b/ê¸‰ë“±/g')
          korean_text=$(echo "$korean_text" | sed 's/\bplunges\b/ê¸‰ë½/g')
          korean_text=$(echo "$korean_text" | sed 's/\binvestment\b/íˆ¬ì/g')
          korean_text=$(echo "$korean_text" | sed 's/\bmarket\b/ì‹œì¥/g')
          korean_text=$(echo "$korean_text" | sed 's/\bcompany\b/íšŒì‚¬/g')
          korean_text=$(echo "$korean_text" | sed 's/\bquarter\b/ë¶„ê¸°/g')
          korean_text=$(echo "$korean_text" | sed 's/\banalyst\b/ì• ë„ë¦¬ìŠ¤íŠ¸/g')
          korean_text=$(echo "$korean_text" | sed 's/\btarget\b/ëª©í‘œê°€/g')
          korean_text=$(echo "$korean_text" | sed 's/\bupgrade\b/ìƒí–¥ì¡°ì •/g')
          korean_text=$(echo "$korean_text" | sed 's/\bdowngrade\b/í•˜í–¥ì¡°ì •/g')
          korean_text=$(echo "$korean_text" | sed 's/\bbuy\b/ë§¤ìˆ˜/g')
          korean_text=$(echo "$korean_text" | sed 's/\bsell\b/ë§¤ë„/g')
          korean_text=$(echo "$korean_text" | sed 's/\bhold\b/ë³´ìœ /g')
          
          # íšŒì‚¬/ê¸°ìˆ  ìš©ì–´
          korean_text=$(echo "$korean_text" | sed 's/\bTesla\b/í…ŒìŠ¬ë¼/g')
          korean_text=$(echo "$korean_text" | sed 's/\bPalantir\b/íŒ”ë€í‹°ì–´/g')
          korean_text=$(echo "$korean_text" | sed 's/\bMarvell\b/ë§ˆë²¨/g')
          korean_text=$(echo "$korean_text" | sed 's/\belectric vehicle\b/ì „ê¸°ì°¨/g')
          korean_text=$(echo "$korean_text" | sed 's/\bEV\b/ì „ê¸°ì°¨/g')
          korean_text=$(echo "$korean_text" | sed 's/\bautonomous\b/ììœ¨ì£¼í–‰/g')
          korean_text=$(echo "$korean_text" | sed 's/\bAI\b/AI/g')
          korean_text=$(echo "$korean_text" | sed 's/\bartificial intelligence\b/ì¸ê³µì§€ëŠ¥/g')
          korean_text=$(echo "$korean_text" | sed 's/\bbitcoin\b/ë¹„íŠ¸ì½”ì¸/g')
          korean_text=$(echo "$korean_text" | sed 's/\bcryptocurrency\b/ì•”í˜¸í™”í/g')
          korean_text=$(echo "$korean_text" | sed 's/\bblockchain\b/ë¸”ë¡ì²´ì¸/g')
          korean_text=$(echo "$korean_text" | sed 's/\bquantum\b/ì–‘ì/g')
          korean_text=$(echo "$korean_text" | sed 's/\bcloud\b/í´ë¼ìš°ë“œ/g')
          korean_text=$(echo "$korean_text" | sed 's/\bsemiconductor\b/ë°˜ë„ì²´/g')
          korean_text=$(echo "$korean_text" | sed 's/\bchip\b/ì¹©/g')
          
          echo "$korean_text"
        }
        
        # ë„¤ì´ë²„ ë‰´ìŠ¤ í™•ì¸
        naver_news=$(curl -s "https://news.google.com/rss/search?q=NAVER+Korea+stock+ë„¤ì´ë²„" 2>/dev/null || echo "")
        if [ ! -z "$naver_news" ]; then
          naver_title=$(echo "$naver_news" | grep -o '<title><!\[CDATA\[.*\]\]></title>' | head -2 | tail -1 | sed 's/<title><!\[CDATA\[//g' | sed 's/\]\]><\/title>//g')
          
          if [ ! -z "$naver_title" ] && [ "$naver_title" != "" ] && [ "$naver_title" != "Google News" ]; then
            if echo "$naver_title" | grep -q '[ê°€-í£]'; then
              translated_title="$naver_title"
            else
              translated_title=$(translate_to_korean "$naver_title")
            fi
            
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -d "chat_id=${{ secrets.CHAT_ID }}" \
              -d "text=ğŸ‡°ğŸ‡· NAVER (035420) ìµœì‹  ë‰´ìŠ¤

            ğŸ“° ${translated_title}

            ğŸ”— ë‰´ìŠ¤ ë§í¬: https://news.google.com/search?q=NAVER+Korea
            ğŸ“Š ì£¼ê°€ í™•ì¸: https://finance.yahoo.com/quote/035420.KS

            ğŸ“… $(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ %H:%M KST')"
          fi
        fi
        
        # ë¯¸êµ­ ì¢…ëª©ë“¤ ë‰´ìŠ¤ í™•ì¸
        for symbol in "${!stocks[@]}"; do
          company_name="${stocks[$symbol]}"
          echo "ë‰´ìŠ¤ í™•ì¸: $symbol ($company_name)"
          
          news_data=$(curl -s "https://news.google.com/rss/search?q=${symbol}+${company_name// /+}+stock" 2>/dev/null || echo "")
          
          if [ ! -z "$news_data" ]; then
            english_title=$(echo "$news_data" | grep -o '<title><!\[CDATA\[.*\]\]></title>' | head -2 | tail -1 | sed 's/<title><!\[CDATA\[//g' | sed 's/\]\]><\/title>//g')
            
            if [ ! -z "$english_title" ] && [ "$english_title" != "" ] && [ "$english_title" != "Google News" ]; then
              korean_title=$(translate_to_korean "$english_title")
              news_link="https://news.google.com/search?q=${symbol}+stock"
              
              case "$symbol" in
                "TSLA") emoji="ğŸš—" ;;
                "PLTR") emoji="ğŸ”" ;;
                "MRVL") emoji="ğŸ’" ;;
                "BTM") emoji="â‚¿" ;;
                "GLXY") emoji="ğŸŒŒ" ;;
                "OSCR") emoji="ğŸ¥" ;;
                "OKLO") emoji="âš›ï¸" ;;
                "AEVA") emoji="ğŸ“¡" ;;
                "NBIS") emoji="ğŸ”¬" ;;
                "ARQQ") emoji="âš›ï¸" ;;
                "CRCL") emoji="ğŸŒ" ;;
                "CRWV") emoji="â˜ï¸" ;;
                *) emoji="ğŸ“ˆ" ;;
              esac
              
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
                -d "chat_id=${{ secrets.CHAT_ID }}" \
                -d "text=${emoji} ${symbol} (${company_name}) ìµœì‹  ë‰´ìŠ¤

              ğŸ“° ${korean_title}

              ğŸ”— ë‰´ìŠ¤ ë§í¬: ${news_link}
              ğŸ“Š ì£¼ê°€ í™•ì¸: https://finance.yahoo.com/quote/${symbol}

              ğŸ“… $(TZ='Asia/Seoul' date '+%Yë…„ %mì›” %dì¼ %H:%M KST')"
              
              sleep 3
            fi
          fi
          
          sleep 1
        done
        
        echo "ëª¨ë“  ë‰´ìŠ¤ í™•ì¸ ì™„ë£Œ"
