name: Tesla Technical Analysis Test

on:
  workflow_dispatch:

jobs:
  tesla-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - name: Get Tesla Real Time Data and Technical Analysis
      run: |
        echo "테슬라 실시간 데이터 및 기술적 분석 시작"
        
        # Yahoo Finance API에서 테슬라 데이터 가져오기
        tsla_data=$(curl -s "https://query1.finance.yahoo.com/v8/finance/chart/TSLA?range=3mo&interval=1d")
        
        if [ ! -z "$tsla_data" ] && echo "$tsla_data" | grep -q "regularMarketPrice"; then
          echo "테슬라 데이터 수신 성공"
          
          # 현재 가격 추출
          current_price=$(echo "$tsla_data" | grep -o '"regularMarketPrice":[0-9.]*' | head -1 | cut -d':' -f2)
          previous_close=$(echo "$tsla_data" | grep -o '"previousClose":[0-9.]*' | head -1 | cut -d':' -f2)
          day_high=$(echo "$tsla_data" | grep -o '"regularMarketDayHigh":[0-9.]*' | head -1 | cut -d':' -f2)
          day_low=$(echo "$tsla_data" | grep -o '"regularMarketDayLow":[0-9.]*' | head -1 | cut -d':' -f2)
          volume=$(echo "$tsla_data" | grep -o '"regularMarketVolume":[0-9]*' | head -1 | cut -d':' -f2)
          
          # 변화량 계산
          if [ ! -z "$current_price" ] && [ ! -z "$previous_close" ]; then
            change=$(echo "$current_price - $previous_close" | bc -l)
            change_percent=$(echo "scale=2; ($change / $previous_close) * 100" | bc -l)
          else
            current_price="245.50"
            previous_close="243.20"
            change="2.30"
            change_percent="0.95"
            day_high="248.90"
            day_low="241.80"
            volume="45000000"
          fi
          
          # 추세 판단
          if (( $(echo "$change >= 0" | bc -l) )); then
            trend_emoji="📈"
            trend_text="상승"
            sign="+"
          else
            trend_emoji="📉"
            trend_text="하락"
            sign=""
          fi
          
          # 일중 변동폭 계산
          daily_range=$(echo "scale=2; (($day_high - $day_low) / $current_price) * 100" | bc -l)
          
          # 현재가 위치 (일중 구간에서)
          price_position=$(echo "scale=2; (($current_price - $day_low) / ($day_high - $day_low)) * 100" | bc -l)
          
          # 지지/저항선 계산 (간단한 방법)
          support_1=$(echo "scale=2; $current_price * 0.95" | bc -l)
          support_2=$(echo "scale=2; $current_price * 0.90" | bc -l)
          resistance_1=$(echo "scale=2; $current_price * 1.05" | bc -l)
          resistance_2=$(echo "scale=2; $current_price * 1.10" | bc -l)
          
          # RSI 추정 (변화율 기반 간단 계산)
          if (( $(echo "$change_percent > 3" | bc -l) )); then
            rsi_estimate="75"
            rsi_status="과매수 경향"
          elif (( $(echo "$change_percent < -3" | bc -l) )); then
            rsi_estimate="25"
            rsi_status="과매도 경향"
          elif (( $(echo "$change_percent > 1" | bc -l) )); then
            rsi_estimate="65"
            rsi_status="강세"
          elif (( $(echo "$change_percent < -1" | bc -l) )); then
            rsi_estimate="35"
            rsi_status="약세"
          else
            rsi_estimate="50"
            rsi_status="중립"
          fi
          
          # 볼륨 분석
          avg_volume="35000000"  # 평균 거래량 추정치
          if [ "$volume" -gt "$avg_volume" ]; then
            volume_status="평균 이상 (${volume})"
            volume_signal="거래량 증가"
          else
            volume_status="평균 이하 (${volume})"
            volume_signal="거래량 감소"
          fi
          
          # 변동성 분석
          if (( $(echo "$daily_range > 5" | bc -l) )); then
            volatility_status="높은 변동성 (${daily_range}%)"
          elif (( $(echo "$daily_range > 3" | bc -l) )); then
            volatility_status="보통 변동성 (${daily_range}%)"
          else
            volatility_status="낮은 변동성 (${daily_range}%)"
          fi
          
          # 가격 위치 분석
          if (( $(echo "$price_position > 80" | bc -l) )); then
            position_status="일중 고점 근처 (상위 ${price_position}%)"
            position_signal="저항 근접"
          elif (( $(echo "$price_position < 20" | bc -l) )); then
            position_status="일중 저점 근처 (하위 ${price_position}%)"
            position_signal="지지 근접"
          else
            position_status="일중 중간 구간 (${price_position}%)"
            position_signal="중립"
          fi
          
        else
          echo "테슬라 데이터 가져오기 실패, 예시 데이터 사용"
          current_price="245.50"
          previous_close="243.20"
          change="2.30"
          change_percent="0.95"
          day_high="248.90"
          day_low="241.80"
          volume="45000000"
          trend_emoji="📈"
          trend_text="상승"
          sign="+"
          daily_range="2.85"
          price_position="65.5"
          support_1="233.23"
          support_2="220.95"
          resistance_1="257.78"
          resistance_2="270.05"
          rsi_estimate="58"
          rsi_status="중립"
          volume_status="평균 이상"
          volume_signal="거래량 증가"
          volatility_status="낮은 변동성"
          position_status="일중 중간 구간"
          position_signal="중립"
        fi
        
        # 종합 기술적 분석 메시지 전송
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}" \
          -d "text=🚗 TSLA (테슬라) 실시간 기술적 분석

        💰 현재가: \$${current_price}
        📊 변동: ${sign}${change} (${sign}${change_percent}%) ${trend_emoji}
        📈 일중 고가: \$${day_high}
        📉 일중 저가: \$${day_low}
        
        ━━━━━━━━━━━━━━━━━━━━━━━━
        
        🎯 지지/저항선 분석:
        🔴 1차 저항: \$${resistance_1}
        🔴 2차 저항: \$${resistance_2}
        🟢 1차 지지: \$${support_1}
        🟢 2차 지지: \$${support_2}
        
        📊 기술적 지표:
        • RSI 추정: ${rsi_estimate} (${rsi_status})
        • 가격 위치: ${position_status}
        • 신호: ${position_signal}
        
        📈 거래량 분석:
        • 오늘 거래량: ${volume_status}
        • 시그널: ${volume_signal}
        
        📉 변동성 분석:
        • 일중 변동폭: ${volatility_status}
        • 트렌드: ${trend_text} 모멘텀
        
        ━━━━━━━━━━━━━━━━━━━━━━━━
        
        💡 기술적 분석 요약:
        • 단기 추세: ${trend_text} (${change_percent}%)
        • 핵심 지지선: \$${support_1}
        • 핵심 저항선: \$${resistance_1}
        • RSI 상태: ${rsi_status}
        • 거래량: ${volume_signal}
        
        🔗 실시간 차트: https://finance.yahoo.com/quote/TSLA
        📊 상세 분석: https://www.tradingview.com/symbols/TSLA
        
        📅 $(TZ='Asia/Seoul' date '+%Y년 %m월 %d일 %H:%M KST')
        
        ⚠️ 투자 참고용이며 실제 투자 결정은 신중하게 하세요."
        
        echo "✅ 테슬라 기술적 분석 전송 완료"

    - name: Send Technical Analysis Summary
      run: |
        sleep 3
        echo "기술적 분석 방법론 설명"
        
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}" \
          -d "text=📚 기술적 분석 방법론 설명

        🔍 이 분석에서 사용한 지표들:

        📊 지지/저항선:
        • 현재가 기준 ±5%, ±10% 계산
        • 실제로는 과거 고점/저점 활용 필요

        📈 RSI (상대강도지수):
        • 일일 변화율 기반 추정
        • 70 이상: 과매수, 30 이하: 과매도
        • 실제로는 14일 RSI 계산 필요

        📊 거래량 분석:
        • 평균 거래량과 비교
        • 가격 상승 + 거래량 증가 = 강한 신호

        📉 변동성 분석:
        • 일중 고저점 차이로 계산
        • 5% 이상: 높은 변동성

        🎯 가격 위치:
        • 일중 구간에서 현재가 위치
        • 80% 이상: 고점 근처
        • 20% 이하: 저점 근처

        💡 참고사항:
        • 이것은 기본적인 기술적 분석입니다
        • 실제 투자 시에는 더 정교한 분석 필요
        • 여러 지표를 종합적으로 판단하세요
        
        📅 $(TZ='Asia/Seoul' date '+%Y년 %m월 %d일 %H:%M KST')"
